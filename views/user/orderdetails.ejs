<%- include('../layouts/header.ejs') -%>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>


<div class="section page-banner-section" style="background-image: url(asset/images/page-banner.jpg)">
    <div class="container">
        <!-- Page Banner Content End -->
        <div class="page-banner-content">
            <h2 class="title">Detail view</h2>

            <ul class="breadcrumb">
                <li><a href="index.html">Home</a></li>
                <li class="active">My Account</li>
            </ul>
        </div>
        <!-- Page Banner Content End -->
    </div>
</div>

<style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

  </style>
 
<div class="container">
    <div class="row">
    <h3 class="mt-3">ORDER DETAILS</h3>
      <div id="reloadArea" >
  
        <div class="card card-dashboard mt-3" style="max-width: 350px; flex: 1;">
          <div class="card-body">
            <h4 class="name">OrderId: <%= orderData._id %></h4>
            <p><b>Date:</b> <%= orderData.orderDate.toLocaleDateString('en-GB') %>
            <br><b>Payment Method:</b> <%= orderData.payment %><br>
            <b>Address:</b><%= orderData.delivery_address.name %>,<%= orderData.delivery_address.address %> <br>
            </p>

          </div>
        </div>
        
      </div>
    </div>
  </div>

  
  <% if (orderData.products.length > 0) { %>
    <div class="container mt-5">
        <h3 class="mb-4">Ordered Products</h3>
        <% orderData.products.forEach(function(product, index) { %>
            <div class="card mt-3">
                <div class="card-body d-flex justify-content-start">
                    <div class="product-card d-flex">
                        <div class="product-image">
                            <a href="/detailshop?id=<%= product.productId._id %>">
                                <img src="sharpimages/<%= product.productId.images.image1 %>" alt="" class="img-thumbnail" style="max-height: 250px; max-width: 230px;">
                            </a>
                        </div>
                        <div class="mx-3" style="width: 180px;">
                            <h5 class="product-details"><a href="/detailshop?id=<%= product.productId._id %>"><%= product.productId.name %></a></h5>
                            <p class="product-details">
                                <%= product.productId.categoryId.name %> <br>
                                Price: ₹<%= product.price %> <br>
                                Quantity: <%= product.quantity %> <br>
                                Total: ₹<%= product.totalPrice %> <br>
                                <% if (orderData.orderStatus !== 'Cancelled' || product.productStatus === 'Cancelled') { %>
                                    <div id="cancelSection">
                                        <input type="number" min="1" max="<%= product.quantity %>" id="quantity" value="1" class="form-control" inputmode="none">
                                        <span id="error-message" class="error-text"></span>
                                        <br>
                                        <button class="cancel-btn" onclick="validateAndCancel('<%= product.productId._id %>', '<%= orderData._id %>')">Cancel order</button>
                                    </div>
                                <% } %>
                            </p>
                        </div>
                    </div>
                    <div class="status-line">
                        <div class="line placed" id="packedLine">
                            <div class="status">Packed</div>
                        </div>
                        <div class="line shipped" id="shippedLine">
                            <div class="status">Shipped</div>
                        </div>
                        <div class="line out-for-delivery" id="outLine">
                            <div class="status">Out to Delivery</div>
                        </div>
                        <div class="line delivered" id="deliveredLine">
                            <div class="status">Delivered</div>
                        </div>
                    </div>
                </div>
            </div>
        <% }); %>
    </div>

    <script>
        // Assuming orderStatus is a variable that holds the order status
        var orderStatus = '<%= orderData.orderStatus %>';
    
        // Get all lines within each product card
        var productLines = document.querySelectorAll('.status-line');
    
        // Loop through product lines and update background based on orderStatus (in reverse order)
        productLines.forEach(function (statusLine) {
            var lines = statusLine.querySelectorAll('.line');
            var highlight = false;
    
            for (var i = lines.length - 1; i >= 0; i--) {
                var lineClass = lines[i].classList[i]; // get the second class, which corresponds to the status
    
                if (lineClass === orderStatus || highlight) {
                    lines[i].style.background = 'green';
                    highlight = true;
                } else {
                    lines[i].style.background = 'none';
                }
            }
        });
    </script>
    
<% } %>




<script>
const packedLine = document.getElementById('packedLine');
const shippedLine = document.getElementById('shippedLine');
const OutLine = document.getElementById('OutLine');
const deliveredLine = document.getElementById('deliveredLine');

packedLine.classList.add('packed');
shippedLine.classList.add('shipped');
packedLine.classList.add('packed');
shippedLine.classList.add('shipped');
</script>

<% if (orderData.cancelledProduct && orderData.cancelledProduct.length > 0) { %>
    <div class="container mt-5">
        <h3 class="mb-4">Cancelled Products</h3>
        <% orderData.cancelledProduct.forEach(function(cancelledProduct, index) { %>
        <div class="card mt-3">
            <div class="card-body d-flex justify-content-start" >
                <div class="cancelled-product-card d-flex">
                    <div class="cancelled-product-image ">
                        <a href="/detailshop?id=<%= cancelledProduct.productDetails._id %>">
                                <img src="sharpimages/<%= cancelledProduct.productDetails.images.image1 %>" alt="" class="img-thumbnail" style="max-height: 250px; max-width: 150px;">
                            </a>
                        </div>
                        <div class="mx-3 " style="width: 180px;">
                        <div class="product-details">
                            <h5 class="product-details"><a href="/detailshop?id=<%= cancelledProduct.productDetails._id %>"><%= cancelledProduct.productDetails.name %></a></h5>
                            <p>Price:₹ <%= cancelledProduct.productDetails.price %>
                            <br>Quantity: <%= cancelledProduct.quantity %> 
                            <br>Status: <%= cancelledProduct.productStatus %>
                           <br>Cancel Reason: <%= cancelledProduct.cancelReason %></p>
                        </div>
                    </div>
                </div>
                
                <div class="status-cancel">
                    <div class="line cancel" id="cancel">
                      <div class="inner-line-1"></div>
                      <div class="status">Packed</div>
                    </div>
                    <div class="line cancelLine" id="cancelLine">
                      <div class="inner-line-2"></div>
                      <div class="status">Cancelled</div>
                    </div>
                </div>
                
            </div>
        </div>
        <% }); %>
    </div>
<% } %>
<br><br>

      

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
    function showCancelConfirmation(productId,orderId,count) {
        Swal.fire({
            title: 'Cancel Order',
            input: 'text',
            inputLabel: 'Reason for cancellation',
            showCancelButton: true,
            confirmButtonText: 'Cancel Order',
            cancelButtonText: 'Close',
            preConfirm: (reason) => {
                if (!reason) {
                    Swal.showValidationMessage('Please enter a reason');
                }
                return reason;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const cancelReason = result.value;
                cancelProduct(productId,orderId, cancelReason,count);
            }
        });
    }

    function cancelProduct(productId,orderId, cancelReason,count) {
        $.ajax({
            type: 'POST',
            url: '/cancelorder',
            data: {productId, orderId, cancelReason,count},
            success: function (response) {
                if (response.success) {
                    Swal.fire('Order Canceled', 'Your order has been canceled.', 'success').then(() => {
                    location.reload();      
                    // $("#reloadDiv").load("/showcart #reloadDiv");
                    });
                } else {
                    Swal.fire('Error', 'Failed to cancel the order.', 'error');
                }

            },
            error: function (error) {
                console.error('Error canceling order', error);
            }
        });
    }



</script>
<script>
  function validateAndCancel(productId, orderId) {
      var quantityInput = document.getElementById('quantity');
      var quantityValue = parseInt(quantityInput.value, 10);

      if (quantityValue < parseInt(quantityInput.min, 10) || quantityValue > parseInt(quantityInput.max, 10)) {
          document.getElementById('error-message').innerText = 'Invalid quantity';
          return;
      }
      document.getElementById('error-message').innerText = '';
      showCancelConfirmation(productId, orderId, quantityValue);
  }
</script>





<%- include('../layouts/footer.ejs') -%>
